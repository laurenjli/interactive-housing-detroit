library(tidyverse)
library(jsonlite)
library(magrittr)
library(here)
library(sf)
blight_f <- '/Users/laurenli/Documents/CAPP Winter 2019/Data Viz/housing_detroit/detroit_data/Blight_Violations.csv'
district_f <- '/Users/laurenli/Documents/CAPP Winter 2019/Data Viz/housing_detroit/detroit_data/City Council Districts/geo_export_c0cba125-2fb0-432f-9a11-e6bb3c7dd89e.shp'
neigh_f <- '/Users/laurenli/Documents/CAPP Winter 2019/Data Viz/housing_detroit/detroit_data/Detroit Neighborhoods/geo_export_30086289-81b8-46bd-bbf7-9d8d3ae67dce.shp'
blight_df <- read_csv(blight_f)
blight_df %<>%
mutate(ticketID = `Ticket ID`) %>%
mutate(violationDate = as.Date(`Violation Date`,format = "%m/%d/%y")) %>%
mutate(year = strftime(violationDate, '%y')) %>%
mutate(totalDue = `Judgment Amount (Total Due)`) %>%
mutate(lat = `Violation Latitude`) %>%
mutate(long = `Violation Longitude`) %>%
mutate(location = `Violation Location`)
blight_select <- blight_df %>%
select(ticketID, violationDate, year, totalDue, lat, long, location) %>%
filter(!is.na(location))
blight_df %<>%
mutate(ticketID = `Ticket ID`) %>%
mutate(violationDate = as.Date(`Violation Date`,format = "%m/%d/%y")) %>%
mutate(year = strftime(violationDate, '%y')) %>%
filter(year %in% c("14","15","16","17","18"))
blight_df %<>%
mutate(ticketID = `Ticket ID`) %>%
mutate(violationDate = as.Date(`Violation Date`,format = "%m/%d/%y")) %>%
mutate(year = strftime(violationDate, '%y')) %>%
filter(year %in% c("14","15","16","17","18")) %>%
mutate(totalDue = `Judgment Amount (Total Due)`) %>%
mutate(lat = `Violation Latitude`) %>%
mutate(long = `Violation Longitude`) %>%
mutate(location = `Violation Location`)
blight_select <- blight_df %>%
select(ticketID, violationDate, year, totalDue, lat, long, location) %>%
filter(!is.na(location))
unique(blight_select$year)
write_csv(blight_select, 'select_blight.csv')
blight_select <- read_csv('select_blight.csv') %>% filter(!is.na(location))
#need to do intersect with districts and neighborhoods to get info on those
districts_shp <- st_read(district_f)
blight_points <- data.frame('ticketID' = blight_select$ticketID, 'Long' = blight_select$long, 'Lat' =blight_select$lat)
tmp <- st_as_sf(blight_points[1:3,], coords = c('Long','Lat'), crs=st_crs(districts_shp)[[1]])
tmp <- st_transform(tmp, crs = st_crs(districts_shp)[[2]])
tmp$councilDistrict <- apply(st_intersects(districts_shp, tmp, sparse = FALSE), 2,
function(col) {
districts_shp[which(col), ]$districts
})
View(tmp)
tmp <- st_as_sf(blight_points, coords = c('Long','Lat'), crs=st_crs(districts_shp)[[1]])
tmp <- st_transform(tmp, crs = st_crs(districts_shp)[[2]])
tmp$councilDistrict <- apply(st_intersects(districts_shp, tmp, sparse = FALSE), 2,
function(col) {
districts_shp[which(col), ]$districts
})
View(tmp)
View(tmp)
unique(tmp$councilDistrict)
as.character(tmp$councilDistrict)
tmp %>% mutate(councilDistrict = as.character(councilDistrict))
unlist(councilDistrict)
unlist(tmp$councilDistrict)
tmp %<>% mutate(councilDistrict=as.character(councilDistrict))
unlist(tmp$councilDistrict)
x <- tmp %>% select(ticketID, councilDistrict)
#x <- tmp %>% mutate(ticketID = ID)
blight_w_district <- left_join(blight_select, x, by='ticketID')
write_csv(data.frame(blight_w_district), 'blight_district.csv')
unique(blight_w_district$councilDistrict)
tst <- blight_w_district %>% filter(councilDistrict != "integer(0)") %>% mutate(councilDistrict = ifelse(councilDistrict == "1:2", "1", councilDistrict))
unique(tst$councilDistrict)
blight_w_district %<>%
filter(councilDistrict != "integer(0)") %>%
mutate(councilDistrict = ifelse(councilDistrict == "1:2", "1", councilDistrict))
write_csv(data.frame(blight_w_district), 'blight_district.csv')
##now do for neighborhoods
neighbor_shp <- st_read(neigh_f)
blight_points <- data.frame('ticketID' = blight_select$ticketID, 'Long' = blight_select$long, 'Lat' =blight_select$lat)
tmp_n <- st_as_sf(blight_points, coords = c('Long','Lat'), crs=st_crs(neighbor_shp)[[1]])
tmp_n <- st_transform(tmp_n, crs = st_crs(neighbor_shp)[[2]])
tmp_n$nhood_name <- apply(st_intersects(neighbor_shp, tmp_n, sparse = FALSE), 2,
function(col) {
neighbor_shp[which(col), ]$nhood_name
})
y <- tmp_n %>% mutate(neighborhood = as.character(nhood_name))
y <- tmp_n %>% mutate(neighborhood = as.character(nhood_name)) %>%
select(ticketID, neighborhood)
unique(y$neighborhood)
nhood_file <-  '/Users/laurenli/Documents/CAPP Winter 2019/Data Viz/housing_detroit/detroit_data/Detroit_Neighborhoods.csv'
nhood_df <- read_csv(nhood_file) %>% select(NHood_Num, NHood_Name) %>% mutate(neighborhood = NHood_Num)
nhood_df <- read_csv(nhood_file) %>% select(NHood_Num, NHood_Name) %>% mutate(neighborhood =as.character(NHood_Num))
with_name <- left_join(y, nhood_df, by = 'neighborhood')
View(with_name)
final_blight <- left_join(blight_w_district, with_name %>% select(ticketID, NHood_Name), by = ticketID)
final_blight <- left_join(blight_w_district, with_name %>% select(ticketID, NHood_Name), by = 'ticketID')
View(final_blight)
write_csv(final_blight, 'final_blight.csv')
blight_json <- as.data.frame(final_blight) %>% select(ticketID, violationDate, year, totalDue, lat, long, location, councilDistrict, NHood_Name)
blight_j <- toJSON(blight_json, pretty=TRUE)
write(blight_j, "blight.json")
library(jsonlite)
library(geojsonio)
install.packages('geojsonio')
install.packages("geojsonio")
library(jsonlite)
library(geojsonio)
x <- fromJSON('sales.json',simplifyDataFrame = T)
x
geojson_write(x, lat=lat, lon = long, geometry = 'point', file='test.geojson')
geojson_write(x, lat=x$lat, lon = x$long, geometry = 'point', file='test.geojson')
geojson_write(x, geometry = 'point', file='test.geojson')
y = fromJSON('blight.json', simplifyDataFrame = T)
geojson_write(y, geometry = 'point', file='blight.geojson')
z <- fromJSON('dem.json', simplifyDataFrame = T)
geojson_write(z, geometry = 'point', file='dem.geojson')
library(tidyverse)
library(jsonlite)
library(geojsonio)
library(magrittr)
library(here)
library(sf)
blight_f <- '/Users/laurenli/Documents/CAPP Winter 2019/Data Viz/housing_detroit/detroit_data/Blight_Violations.csv'
dem_f <- '/Users/laurenli/Documents/CAPP Winter 2019/Data Viz/housing_detroit/detroit_data/Detroit_Demolitions.csv'
sale_f <- '/Users/laurenli/Documents/CAPP Winter 2019/Data Viz/housing_detroit/detroit_data/Side_Lot_Sales.csv'
own_f <- '/Users/laurenli/Documents/CAPP Winter 2019/Data Viz/housing_detroit/detroit_data/Own_It_Now_Sales.csv'
auction_f <- '/Users/laurenli/Documents/CAPP Winter 2019/Data Viz/housing_detroit/detroit_data/DLBA_Auctions_Closed.csv'
district_f <- '/Users/laurenli/Documents/CAPP Winter 2019/Data Viz/housing_detroit/detroit_data/City Council Districts/geo_export_c0cba125-2fb0-432f-9a11-e6bb3c7dd89e.shp'
neigh_f <- '/Users/laurenli/Documents/CAPP Winter 2019/Data Viz/housing_detroit/detroit_data/Detroit Neighborhoods/geo_export_30086289-81b8-46bd-bbf7-9d8d3ae67dce.shp'
sale_df <- read_csv(sale_f)
own_df <- read_csv(own_f)
auc_df <- read_csv(auction_f)
sale_df <- sale_df %>%
mutate(saleDate = as.Date(`Closing Date`,format = "%m/%d/%Y")) %>%
mutate(price = `Final Sale Price`) %>%
mutate(year = as.numeric(strftime(saleDate, '%y'))) %>%
mutate(councilDistrict = `Council District`) %>%
mutate(lat = Latitude) %>%
mutate(long = Longitude) %>%
mutate(location = Location) %>%
mutate(neighborhood = Neighborhood) %>%
mutate(category = 'Side Lot')
own_df <- own_df %>%
mutate(saleDate = as.Date(`Closing Date`,format = "%m/%d/%Y")) %>%
mutate(price = `Final Sale Price`) %>%
mutate(year = as.numeric(strftime(saleDate, '%y'))) %>%
mutate(councilDistrict = `Council District`) %>%
mutate(lat = Latitude) %>%
mutate(long = Longitude) %>%
mutate(location = Location) %>%
mutate(neighborhood = Neighborhood) %>%
mutate(category = 'Own It Now')
auc_df <- auc_df %>%
mutate(saleDate = as.Date(`Closing Date`,format = "%m/%d/%Y")) %>%
mutate(price = `Final Sale Price`) %>%
mutate(year = as.numeric(strftime(saleDate, '%y'))) %>%
mutate(councilDistrict = `Council District`) %>%
mutate(lat = Latitude) %>%
mutate(long = Longitude) %>%
mutate(location = Location) %>%
mutate(neighborhood = Neighborhood) %>%
mutate(category = 'Auction')
sale_select <- sale_df %>% select(category, saleDate, year, price, councilDistrict, neighborhood, lat, long, location)
own_select <- own_df %>% select(category, saleDate, year, price, councilDistrict, neighborhood, lat, long, location)
auc_select <- auc_df %>% select(category, saleDate, year, price, councilDistrict, neighborhood, lat, long, location)
all_sale <- rbind(sale_select,own_select)
final <- rbind(all_sale, auc_select)
all_j <- toJSON(final, pretty=TRUE)
write(all_j, "sales.json")
dem_df <- read_csv(dem_f)
dem_df %<>%
mutate(demolitionDate = as.Date(`Demolition Date`,format = "%m/%d/%Y")) %>%
mutate(price = Price) %>%
mutate(year = as.numeric(strftime(saleDate, '%y'))) %>%
mutate(councilDistrict = Council_District) %>%
mutate(lat = Latitude) %>%
mutate(long = Longitude) %>%
mutate(location = Location) %>%
mutate(neighborhood = Neighborhood)
dem_select <- dem_df %>% select(demolitionDate, year, price, councilDistrict, neighborhood, lat, long, location)
dem_j <- toJSON(dem_select, pretty=TRUE)
write(dem_j, "dem.json")
#demolitions
dem_df <- read_csv(dem_f)
dem_df %<>%
mutate(demolitionDate = as.Date(`Demolition Date`,format = "%m/%d/%Y")) %>%
mutate(price = Price) %>%
mutate(year = as.numeric(strftime(demolitionDate, '%y'))) %>%
mutate(councilDistrict = Council_District) %>%
mutate(lat = Latitude) %>%
mutate(long = Longitude) %>%
mutate(location = Location) %>%
mutate(neighborhood = Neighborhood)
dem_select <- dem_df %>% select(demolitionDate, year, price, councilDistrict, neighborhood, lat, long, location)
dem_j <- toJSON(dem_select, pretty=TRUE)
write(dem_j, "dem.json")
unique(dem_select$year)
dem_select %>% filter(year == 14)
